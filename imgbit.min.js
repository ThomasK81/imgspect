(function(a){function c(a,c,d){this.elem=a;this.id=d;this.init(a,c)}c.prototype.init=function(b,c){this.options=a.extend({style:"full",closable:!1},c);this.events={change:"IMGBIT-CHANGE",closed:"IMGBIT-CLOSED"};this.original=a(this.elem).myHtml();this.href=a(this.elem).attr("href");this.caption=a(this.elem).text();this.imgHeight=this.imgWidth=null;this.timeCreated=(new TimeStamp).withUtc(!0);var d=this.href.split("imgbit=");this.src=d[0].substring(0,d[0].length-1);this.param=this.getToJson(d[1]);
void 0!=this.param.w&&(this.param.z=this.param.w/(this.param.x2-this.param.x1));void 0!=this.param.h&&(this.param.z=this.param.h/(this.param.y2-this.param.y1));void 0!=this.param.c&&(this.culuh=new Culuh(this.param.c));this.param.z=void 0==this.param.z?1:this.param.z;a(this.elem).hasClass("min")&&(this.options.style=null);a(this.elem).hasClass("edit")&&(this.options.style="edit");a(this.elem).hasClass("closable")&&(this.options.closable=!0);this.build()};c.prototype.build=function(){var b=this,c=
a(b.elem).attr("id");a(b.elem).after('<div class="imgbit">');b.elem=a(b.elem).next();a(b.elem).attr("id",c);var c=a(b.elem).prev(),d=c.html();c.remove();null!=b.options.style&&a(b.elem).addClass(b.options.style);a(b.elem).append('<div class="view">');null!=b.options.style&&a(b.elem).append('<div class="text">'+d+"</div>");var e=new Image;e.onload=function(){a(this).addClass("star");b.imgWidth=e.width;b.imgHeight=e.height;a(".view",b.elem).append(this);b.viewCrop();b.imgMove();a(b.elem).prepend('<div style="clear:both"></div>');
null!=b.options.style&&"edit"!=b.options.style&&a(b.elem).prepend('<a class="source" href="'+b.src+'">source</a>');a(b.elem).css({width:a(".view",b.elem).width()});b.editStart();!0==b.options.closable&&b.closeBuild();void 0!=b.param.c&&(a(b.elem).css({"background-color":"#"+b.param.c}),a(".close",b.elem).css({"background-color":"#"+b.param.c}));a(b.elem).trigger(b.events.change)};e.src=b.src};c.prototype.closeBuild=function(){var b=this;a(b.elem).prepend('<a href="" class="close">x</a>');a(".close",
b.elem).click(function(c){a(b.elem).trigger(b.events.closed);a(b.elem).trigger(b.events.change);c.preventDefault()})};c.prototype.captionResize=function(){var b=a(".text",this.elem),c=!1;!1==b.is(":visible")&&(c=!0);b.show();var d=b.height();!0==c&&b.hide();b=parseInt(b.css("font-size").replace("px",""));d=d>b?d:b;a(".caption",this.elem).height(d)};c.prototype.editStart=function(){var b=this;"edit"==b.options.style&&(b.editBuild(),b.captionResize(),a(".caption",b.elem).keypress(function(a){13==a.which&&
b.editSwitch()}),a(".caption",b.elem).bind("input propertychange",function(){b.setCaption(a(".caption",b.elem).val())}))};c.prototype.remove=function(){a(this.elem).remove()};c.prototype.setCaption=function(b){this.caption=b;a(".text",this.elem).text(this.caption);this.captionResize();a(this.elem).trigger(this.events.change)};c.prototype.idUpdate=function(b){a(this.elem).attr("id",b)};c.prototype.editBuild=function(){var b=this,c='<textarea class="caption">'+a(".text",b.elem).text()+"</textarea>";
a(".text",b.elem).after(c);a(".caption",b.elem).css({width:a(".view",b.elem).width()});void 0!=b.culuh&&a(".caption",b.elem).css({"background-color":b.culuh.sat(0.35,!0).hex()});a(".caption",b.elem).hide();a(".text",b.elem).click(function(a){b.editSwitch();a.preventDefault()})};c.prototype.editSwitch=function(){a(".caption",this.elem).is(":visible")?this.editHide():(c.prototype.editHide(),this.editShow())};c.prototype.editHide=function(){a(".caption",this.elem).hide();a(".text",this.elem).show()};
c.prototype.editShow=function(){a(".text",this.elem).hide();a(".caption",this.elem).show();a(".caption",this.elem).cursorToEnd()};c.prototype.viewCrop=function(){a(".view",this.elem).css({width:(this.param.x2-this.param.x1)*this.param.z,height:(this.param.y2-this.param.y1)*this.param.z})};c.prototype.imgMove=function(){a("img.star",this.elem).css({width:a("img.star",this.elem).width()*this.param.z,height:a("img.star",this.elem).height()*this.param.z,left:-1*this.param.x1*this.param.z,top:-1*this.param.y1*
this.param.z})};c.prototype.getToJson=function(a){if(""==a)return{};var c={};a=a.split("%");for(var d=0,e=a.length;d<e;d++){var g=a[d].split("=");2==g.length&&(c[g[0]]=decodeURIComponent(g[1].replace(/\+/g,"")))}return c};c.prototype.html=function(){var a=-1==this.src.indexOf("?")?"?":"&";return('<a class="imgbit" \t\t\t\t\t\thref="'+this.src+"\t\t\t\t\t\t"+a+"imgbit=\t\t\t\t\t\tx1="+this.param.x1+"\t\t\t\t\t\t%y1="+this.param.y1+"\t\t\t\t\t\t%x2="+this.param.x2+"\t\t\t\t\t\t%y2="+this.param.y2+"\t\t\t\t\t\t%c="+
this.param.c+"\t\t\t\t\t\t%z="+this.param.z+'">\t\t\t\t\t\t'+this.caption+"\t\t\t\t\t<a>").smoosh()};c.prototype.citeCoords=function(){var a=[];a[0]=this.param.x1/this.imgWidth;a[1]=this.param.y1/this.imgHeight;a[2]=(this.param.x2-this.param.x1)/this.imgWidth;a[3]=(this.param.y2-this.param.y1)/this.imgHeight;for(var c=0,d=a.length;c<d;c++)a[c]=a[c].toFixed(4);return a};c.prototype.toJsonLD=function(a){return{"@context":"http://www.w3.org/ns/oa-context-20130208.json","@type":"oa:Annotation",annotatedAt:this.timeCreated,
annotatedBy:{"@type":"foaf:Person"},motivatedBy:"perseus:transcribing",label:"isQuotationOf"}};jQuery(document).ready(function(a){jQuery.fn.imgbit=function(a){var b=jQuery(this).selector;return this.each(function(){jQuery.data(this,b,new c(this,a,b))})}})})(jQuery);jQuery.fn.cursorToEnd=function(){return this.each(function(){$(this).focus();if(this.setSelectionRange){var a=2*$(this).val().length;this.setSelectionRange(a,a)}else $(this).val($(this).val());this.scrollTop=999999})};
jQuery.fn.myHtml=function(){return $(this).clone().wrap("<div>").parent().html()};jQuery.fn.transLength=function(){var a=$(this).css("transition").match(/ [\d|\.]+s/g);return 1E3*Number(a[0].replace("s",""))};String.prototype.smoosh=function(){return this.replace(/(\r\n+|\n+|\r+|\t+)/gm,"")};String.prototype.occurs=function(a,c){if(void 0==a)return this.length;a+="";if(0>=a.length)return this.length;for(var b=0,f=0,d=c?1:a.length;;)if(f=this.indexOf(a,f),0<=f)b++,f+=d;else break;return b};
String.prototype.params=function(){for(var a=this.split("?"),a=a[1].split("&"),c={},b=0,f=a.length;b<f;b++)if(void 0!=a[b]){var d=a[b].split("=");c[d[0]]=d[1]}return c};String.prototype.hasUpper=function(){return/[A-Z]/.test(this)};String.prototype.report=function(){for(var a=this.toLowerCase().split(" "),c={},b=0,f=a.length;b<f;b++){var d=a[b];c[d]=d in c?c[d]+1:1}return c};String.prototype.lines=function(){return this.split("\n")};
String.prototype.sentences=function(){for(var a=this.match(/[^\.!\?]+[\.!\?]+/g),c="aeiouy".split(""),b=[],f="",d=0;d<a.length;d++){for(var e=f+a[d],f="",g=!0,h=0;h<c.length;h++)if(-1!=e.indexOf(c[h])){g=!1;break}e.trim()[0].hasUpper()||(g=!0);g?0<b.length?b[b.length-1]+=e:f=e:b.push(e.smoosh().trim())}return b};function TimeStamp(){}
TimeStamp.prototype.withUtc=function(a){var c=new Date,b=c.getFullYear(),f=("0"+(c.getMonth()+1)).slice(-2),d=("0"+c.getDate()).slice(-2),e=c.getHours(),g=("0"+c.getMinutes()).slice(-2),h=("0"+c.getSeconds()).slice(-2),k=("0"+c.getMilliseconds()).slice(-3),c=c.getTimezoneOffset(),l="",l=a?b+"-"+f+"-"+d+"T"+e+":"+g+":"+h+":"+k+"UTC":b+"-"+f+"-"+d+"T"+e+":"+g+":"+h+"UTC";return 0<c?l+"+"+c:l+"-"+c};TimeStamp.prototype.unix=function(){return(new Date).getTime()};
TimeStamp.prototype.toUnix=function(a){a=a.replace(/UTC.*/,"");var c=0;a.match(/:\d{3}/)&&(c=a.slice(-4),a=a.replace(/:\d+$/,""),c=parseInt(c.replace(":","")));return Date.parse(a).getTime()+c};function Culuh(a){this.v=this.s=this.h=this.b=this.g=this.r=0;void 0!=a&&(this.original=a,this.reset(),this.hsvUpdate())}
Culuh.prototype.reset=function(){var a=this.original,a=a.toUpperCase();-1<a.indexOf("RGB")?(a=a.match(/\d+\.?\d*/g),this.r=parseInt(a[0]),this.g=parseInt(a[1]),this.b=parseInt(a[2])):(a=a.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i),this.r=this.hexToInt(a[1]),this.g=this.hexToInt(a[2]),this.b=this.hexToInt(a[3]))};
Culuh.prototype.hsvUpdate=function(){var a,c;a=this.r/255;var b=this.g/255,f=this.b/255;c=Math.min(a,b,f);var d=Math.max(a,b,f),e=d-c;c=0==d?0:e/d;0==c?a=0:(a=a==d?(b-f)/e:b==d?2+(f-a)/e:4+(a-b)/e,isNaN(a)&&(a=0),a/=6,0>a&&a++);this.h=255*a;this.s=255*c;this.v=255*d};
Culuh.prototype.rgbUpdate=function(){var a,c,b,f=this.h/255,d=this.s/255,e=this.v/255;if(0==d)a=c=b=e;else{var f=6*f,g=f%1,h=e*(1-d),k=e*(1-d*g),d=e*(1-d*(1-g));switch(Math.floor(f)){case 0:a=e;c=d;b=h;break;case 1:a=k;c=e;b=h;break;case 2:a=h;c=e;b=d;break;case 3:a=h;c=k;b=e;break;case 4:a=d;c=h;b=e;break;case 5:a=e,c=h,b=k}}this.r=parseInt(255*a);this.g=parseInt(255*c);this.b=parseInt(255*b)};Culuh.prototype.hex=function(a){return(void 0==a?"":a)+this.rHex()+this.gHex()+this.bHex()};
Culuh.prototype.rgb=function(){return"rgb("+this.r+","+this.g+","+this.b+")"};Culuh.prototype.rHex=function(){return this.intToHex(this.r)};Culuh.prototype.gHex=function(){return this.intToHex(this.g)};Culuh.prototype.bHex=function(){return this.intToHex(this.b)};Culuh.prototype.rInt=function(){return this.r};Culuh.prototype.gInt=function(){return this.g};Culuh.prototype.bInt=function(){return this.b};Culuh.prototype.hexToInt=function(a){return parseInt(a,16)};
Culuh.prototype.intToHex=function(a){a=a.toString(16);2>a.length&&(a="0"+a);return a.toUpperCase()};Culuh.prototype.sat=function(a,c){var b=this.s,b=b*a;if(!0!=c)this.s=b,this.rgbUpdate();else return b=new Culuh(this.rgb()),b.sat(a),b};Culuh.prototype.invert=function(a){if(!0!=a)this.r=255-this.r,this.g=255-this.g,this.b=255-this.b,this.hsvUpdate();else return a=new Culuh(this.rgb()),a.invert(),a};

